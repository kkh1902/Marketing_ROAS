flowchart TB
 subgraph S["Source Layer"]
        A["Avazu train.gz<br>10일치 광고 로그 40M rows"]
  end
 subgraph I["Ingestion Layer"]
        P["Kafka Producer Python<br>row to JSON 이벤트"]
        SR["Schema Registry<br>Docker"]
  end
 subgraph K["Streaming Layer - Kafka"]
        K1[("Kafka Topic<br>ad_events_raw<br>partition=3")]
        K2[("DLQ Topic<br>ad_events_error")]
        K3["JMX Exporter"]
  end
 subgraph DLQ["DLQ Processing"]
        DC["DLQ Consumer"]
        ER[("PostgreSQL<br>errors schema")]
        ST2["Streamlit<br>에러 대시보드"]
  end
 subgraph F["Flink Realtime Compute"]
        F1["PyFlink Streaming Job<br>Event Time + Watermark<br>1분 5분 Tumbling Window"]
        F2["Flink Metrics"]
        F3[("로컬 Checkpoint<br>./data/checkpoints")]
  end
 subgraph FS["Feature Store"]
        FST["Feast Registry<br>PostgreSQL"]
        FSO[("Redis<br>Online Store")]
        FSB[("PostgreSQL<br>Offline Store")]
  end
 subgraph MLT["ML Training Pipeline"]
        MLF["MLflow<br>localhost:5000"]
        TR["Training Job<br>XGBoost LightGBM"]
        EV["Evidently AI"]
  end
 subgraph MLS["ML Serving"]
        API["FastAPI<br>localhost:8000"]
  end
 subgraph C["Cache Layer"]
        R[("Redis Docker<br>실시간 CTR 캐시")]
  end
 subgraph B["Batch Layer"]
        B1[("로컬 파일<br>./data/raw<br>./data/processed")]
        AF["Airflow<br>localhost:8080"]
        B3["dbt Transform"]
        B4["dbt tests"]
  end
 subgraph AFD["Airflow DAGs"]
        D1["dag_daily_etl"]
        D2["dag_dbt_run"]
        D3["dag_dlq_retry"]
        D5["dag_feature_pipeline"]
        D6["dag_model_training"]
        D7["dag_model_validation"]
  end
 subgraph PGS["PostgreSQL Docker"]
        PG[("realtime schema<br>실시간 메트릭")]
        DW[("analytics schema<br>DW 마트")]
        ERR[("errors schema<br>DLQ 에러")]
        FEAT[("features schema<br>Feast 오프라인")]
  end
 subgraph A2["Analytics Layer"]
        ST["Streamlit<br>실시간 CTR 대시보드<br>localhost:8501"]
        MB["Metabase<br>localhost:3000"]
        ST3["Streamlit<br>ML 대시보드<br>localhost:8502"]
  end
 subgraph AL["Monitoring"]
        AL1["Slack Alert"]
        PR["Prometheus<br>localhost:9090"]
        GF["Grafana<br>localhost:3001"]
  end
    A --> P
    P --> SR
    SR --> K1
    K1 --> F1 & K3
    F1 --> PG & R & F3 & B1 & FSO & F2
    PG --> ST
    R --> ST
    B1 --> AF & D1
    AF --> B3
    B3 --> B4
    B4 --> DW
    DW --> MB & FSB & EV
    FST --> FSO & FSB
    FSB --> FEAT
    FEAT --> TR
    TR --> MLF
    MLF --> API
    EV --> ST3 & AL1
    FSO --> API
    API --> PR
    P -. 파싱 실패 .-> K2
    F1 -. 처리 실패 .-> K2
    K2 --> DC
    DC --> ERR
    ERR --> ST2 & D3
    D3 -- 재처리 --> K1
    D1 --> D2
    D2 --> B3 & D5
    D5 --> FEAT & D6
    D6 --> TR
    D7 --> EV
    K3 --> PR
    F2 --> PR
    PR --> GF & AL1

     A:::source
     P:::source
     SR:::source
     K1:::kafka
     K2:::kafka
     K3:::kafka
     DC:::error
     ER:::error
     ST2:::error
     F1:::flink
     F2:::flink
     F3:::flink
     FST:::ml
     FSO:::ml
     FSB:::ml
     MLF:::ml
     TR:::ml
     EV:::ml
     API:::ml
     R:::analytics
     B1:::batch
     AF:::batch
     B3:::batch
     B4:::batch
     D1:::batch
     D2:::batch
     D3:::batch
     D5:::batch
     D6:::batch
     D7:::batch
     PG:::local
     DW:::local
     ERR:::local
     FEAT:::local
     ST:::analytics
     MB:::analytics
     ST3:::analytics
     AL1:::alert
     PR:::alert
     GF:::alert
    classDef source fill:#EAF4FF,stroke:#6BA8E5,stroke-width:1px
    classDef kafka fill:#FFF4E6,stroke:#FFB95A,stroke-width:1px
    classDef flink fill:#E8FFE8,stroke:#66CC66,stroke-width:1px
    classDef batch fill:#F3E8FF,stroke:#B084F7,stroke-width:1px
    classDef analytics fill:#FFF1F7,stroke:#FF7AAE,stroke-width:1px
    classDef alert fill:#FFEAEA,stroke:#FF6B6B,stroke-width:1px
    classDef infra fill:#E8E8E8,stroke:#888888,stroke-width:1px
    classDef error fill:#FFE4E4,stroke:#FF4444,stroke-width:1px
    classDef ml fill:#E6F3FF,stroke:#4A90D9,stroke-width:2px
    classDef local fill:#E8FFE8,stroke:#228B22,stroke-width:2px