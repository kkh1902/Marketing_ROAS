flowchart TB
 subgraph S["Source Layer"]
        A["Avazu train.gz<br>10일치 광고 로그 40M rows"]
  end

 subgraph I["Ingestion Layer"]
        P["Kafka Producer Python<br>row to JSON 이벤트"]
        SR["Schema Registry<br>Docker"]
  end

 subgraph K["Streaming Layer - Kafka"]
        K1[("Kafka Topic<br>ad_events_raw<br>partition=3")]
        K2[("DLQ Topic<br>ad_events_error")]
        K3["JMX Exporter"]
  end

 subgraph DLQ["DLQ Processing"]
        DC["DLQ Consumer<br>retry 3회 + 에러 저장 + Slack"]
  end

 subgraph F["Flink Realtime Compute"]
        F1["PyFlink Streaming Job<br>Event Time + Watermark<br>1분 5분 Tumbling Window"]
        F2["Flink Metrics"]
        F3[("로컬 Checkpoint<br>./data/checkpoints")]
  end

 subgraph B["Batch Layer"]
        B1[("로컬 파일<br>./data/raw<br>./data/processed")]
        AF["Airflow<br>localhost:8080"]
        B3["dbt Transform"]
        B4["dbt tests"]
  end

 subgraph AFD["Airflow DAGs"]
        D1["dag_daily_etl"]
        D2["dag_dbt_run"]
  end

 subgraph PGS["PostgreSQL Docker"]
        PG[("realtime schema<br>실시간 메트릭")]
        DW[("analytics schema<br>DW 마트")]
        ERR[("errors schema<br>DLQ 에러")]
  end

 subgraph A2["Analytics Layer"]
        ST["Streamlit<br>실시간 CTR 대시보드<br>localhost:8501"]
        MB["Metabase<br>localhost:3000"]
  end

 subgraph AL["Monitoring"]
        AL1["Slack Alert"]
        PR["Prometheus<br>localhost:9090"]
        GF["Grafana<br>localhost:3001"]
  end

    %% 메인 흐름
    A --> P
    P --> SR
    SR --> K1
    K1 --> F1
    K1 --> K3
    F1 --> PG
    F1 --> F3
    F1 --> B1
    F1 --> F2
    PG --> ST

    %% 배치 흐름
    B1 --> AF
    AF --> B3
    B3 --> B4
    B4 --> DW
    DW --> MB
    ERR --> MB

    %% DLQ 흐름
    P -. 파싱 실패 .-> K2
    F1 -. 처리 실패 .-> K2
    K2 --> DC
    DC -- retry 성공 --> K1
    DC -- retry 실패 --> ERR
    DC -- retry 실패 --> AL1

    %% DAG 연결
    B1 --> D1
    D1 --> D2
    D2 --> B3

    %% Monitoring 흐름
    K3 --> PR
    F2 --> PR
    PR --> GF
    PR --> AL1
    AF -. DAG 실패 .-> AL1
    B4 -. test 실패 .-> AL1

     A:::source
     P:::source
     SR:::source
     K1:::kafka
     K2:::kafka
     K3:::kafka
     DC:::error
     F1:::flink
     F2:::flink
     F3:::flink
     B1:::batch
     AF:::batch
     B3:::batch
     B4:::batch
     D1:::batch
     D2:::batch
     PG:::local
     DW:::local
     ERR:::local
     ST:::analytics
     MB:::analytics
     AL1:::alert
     PR:::alert
     GF:::alert

    classDef source fill:#EAF4FF,stroke:#6BA8E5,stroke-width:1px
    classDef kafka fill:#FFF4E6,stroke:#FFB95A,stroke-width:1px
    classDef flink fill:#E8FFE8,stroke:#66CC66,stroke-width:1px
    classDef batch fill:#F3E8FF,stroke:#B084F7,stroke-width:1px
    classDef analytics fill:#FFF1F7,stroke:#FF7AAE,stroke-width:1px
    classDef alert fill:#FFEAEA,stroke:#FF6B6B,stroke-width:1px
    classDef error fill:#FFE4E4,stroke:#FF4444,stroke-width:1px
    classDef local fill:#E8FFE8,stroke:#228B22,stroke-width:2px